{% extends "base.html" %}

{% block title %}{{ post.title }} - {{ board.name }} - AIZEVA{% endblock %}

{% block content %}
<main class="container mx-auto px-4 py-8">
  <!-- Breadcrumb -->
  <nav class="breadcrumb mb-6">
    <div class="text-sm text-gray-500">
      <a href="/" class="hover:text-blue-600 transition-colors">í™ˆ</a>
      <span class="mx-2">></span>
      <a href="/boards" class="hover:text-blue-600 transition-colors">ê²Œì‹œíŒ</a>
      <span class="mx-2">></span>
      <a href="/boards/{{ board.slug }}" class="hover:text-blue-600 transition-colors">{{ board.name }}</a>
      <span class="mx-2">></span>
      <span class="text-gray-800 truncate">{{ post.title[:30] }}{% if post.title|length > 30 %}...{% endif %}</span>
    </div>
  </nav>

  <!-- Post Content -->
  <article class="post-article bg-white rounded-lg shadow border mb-8">
    <!-- Post Header -->
    <header class="post-header p-6 border-b">
      <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">{{ post.title }}</h1>

      <!-- Post Meta -->
      <div class="post-meta flex flex-col md:flex-row md:items-center md:justify-between text-sm text-gray-500">
        <div class="meta-left flex items-center space-x-4 mb-2 md:mb-0">
          <div class="date">{{ post.created_at[:16] if post.created_at is string else post.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
          <div class="author">
            <span class="font-medium text-gray-700">{{ post.users.display_name or post.users.username }}</span>
            {% if post.users and post.users.is_admin %}
            <span class="ml-1 px-1.5 py-0.5 bg-red-100 text-red-600 text-xs rounded">ê´€ë¦¬ì</span>
            {% endif %}
          </div>
          <div class="views">ì¡°íšŒ {{ post.view_count or 0 }}</div>
          {% if post.updated_at and post.updated_at > post.created_at %}
          <div class="updated text-gray-400">(ìˆ˜ì •ë¨)</div>
          {% endif %}
        </div>

        <!-- Post Actions (Owner/Admin only) -->
        {% if current_user and (current_user.id == post.user_id or current_user.is_admin) %}
        <div class="post-actions flex space-x-2">
          <a
            href="/posts/{{ post.id }}/edit"
            class="px-3 py-1 text-blue-600 border border-blue-600 rounded hover:bg-blue-50 text-sm transition-colors"
          >
            ìˆ˜ì •
          </a>
          <button
            class="delete-btn px-3 py-1 text-red-600 border border-red-600 rounded hover:bg-red-50 text-sm transition-colors"
            data-post-id="{{ post.id }}"
            onclick="confirmDelete({{ post.id }})"
          >
            ì‚­ì œ
          </button>
        </div>
        {% endif %}
      </div>
    </header>

    <!-- Post Body -->
    <div class="post-body p-6">
      <div class="prose max-w-none post-content" style="white-space: pre-line;">
        {{ post.content|safe }}
      </div>
    </div>

    <!-- Post Footer -->
    <footer class="post-footer p-6 border-t bg-gray-50">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between">
        <!-- Tags or Categories (if implemented) -->
        <div class="post-tags mb-4 md:mb-0">
          <!-- Reserved for future tag implementation -->
        </div>

        <!-- Share and Actions -->
        <div class="post-share flex items-center space-x-4">
          <button
            onclick="copyUrl()"
            class="px-3 py-1 text-gray-600 border border-gray-300 rounded hover:bg-gray-100 text-sm transition-colors"
          >
            ë§í¬ ë³µì‚¬
          </button>
          <a
            href="/boards/{{ board.slug }}"
            class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm transition-colors"
          >
            ëª©ë¡ìœ¼ë¡œ
          </a>
        </div>
      </div>
    </footer>
  </article>

  <!-- Post Navigation -->
  <div class="post-navigation bg-white rounded-lg shadow border mb-8 p-6">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
      <!-- Previous Post -->
      {% if prev_post %}
      <div class="prev-post flex-1 md:mr-4">
        <div class="text-xs text-gray-500 mb-1">ì´ì „ ê¸€</div>
        <a
          href="/posts/{{ prev_post.id }}"
          class="text-gray-700 hover:text-blue-600 text-sm font-medium transition-colors line-clamp-1"
        >
          {{ prev_post.title }}
        </a>
      </div>
      {% else %}
      <div class="flex-1"></div>
      {% endif %}

      <!-- Divider -->
      <div class="hidden md:block w-px h-12 bg-gray-200 mx-4"></div>

      <!-- Next Post -->
      {% if next_post %}
      <div class="next-post flex-1 md:ml-4 text-right">
        <div class="text-xs text-gray-500 mb-1">ë‹¤ìŒ ê¸€</div>
        <a
          href="/posts/{{ next_post.id }}"
          class="text-gray-700 hover:text-blue-600 text-sm font-medium transition-colors line-clamp-1"
        >
          {{ next_post.title }}
        </a>
      </div>
      {% else %}
      <div class="flex-1"></div>
      {% endif %}
    </div>
  </div>

  <!-- Comments Section -->
  <section class="comments-section bg-white rounded-lg shadow border">
    <!-- Comments Header -->
    <header class="comments-header p-6 border-b">
      <h3 class="text-lg font-semibold text-gray-800">
        ëŒ“ê¸€ <span class="comment-count text-blue-600">{{ comments|length }}</span>
      </h3>
    </header>

    <!-- Comment Form (for logged in users) -->
    {% if current_user %}
      {% if board.slug in ['notice', 'newsletter'] and not current_user.is_admin %}
      <!-- Admin-only comment notice for notice/newsletter boards -->
      <div class="comment-form p-6 border-b bg-gray-50">
        <div class="text-center py-8">
          <div class="text-gray-400 text-3xl mb-4">ğŸ”’</div>
          <h4 class="text-lg font-medium text-gray-700 mb-2">ê´€ë¦¬ì ì „ìš© ëŒ“ê¸€</h4>
          <p class="text-gray-500">ì´ ê²Œì‹œíŒì€ ê´€ë¦¬ìë§Œ ëŒ“ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>
      </div>
      {% else %}
      <!-- Regular comment form -->
      <div class="comment-form p-6 border-b bg-gray-50">
        <form action="/posts/{{ post.id }}/comments" method="POST" class="space-y-4">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>

          <div class="form-group">
            <label for="comment-content" class="block text-sm font-medium text-gray-700 mb-2">
              ëŒ“ê¸€ ì‘ì„±
            </label>
            <textarea
              id="comment-content"
              name="content"
              rows="4"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"
              placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."
              required
              maxlength="1000"
            ></textarea>
            <div class="text-xs text-gray-500 mt-1 text-right">
              <span class="char-count">0</span>/1000
            </div>
          </div>

          <div class="form-actions flex justify-end">
            <button
              type="submit"
              class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm transition-colors"
            >
              ëŒ“ê¸€ ë“±ë¡
            </button>
          </div>
        </form>
      </div>
      {% endif %}
    {% else %}
    <!-- Login prompt for non-logged users -->
    <div class="comment-login-prompt p-6 border-b bg-gray-50 text-center">
      <p class="text-gray-600 mb-4">ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
      <div class="space-x-2">
        <a
          href="/auth/login"
          class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm transition-colors"
        >
          ë¡œê·¸ì¸
        </a>
        <a
          href="/auth/signup"
          class="px-4 py-2 border border-blue-600 text-blue-600 rounded-md hover:bg-blue-50 text-sm transition-colors"
        >
          íšŒì›ê°€ì…
        </a>
      </div>
    </div>
    {% endif %}

    <!-- Comments List -->
    <div class="comments-list" id="comments-list">
      {% if comments %}
        {% for comment in comments %}
        <div class="comment-item p-6 border-b last:border-b-0" data-comment-id="{{ comment.id }}">
          <!-- Main Comment -->
          <div class="comment-main">
            <div class="comment-header flex items-center justify-between mb-3">
              <div class="comment-author flex items-center space-x-2">
                <span class="comment-date text-xs text-gray-500">
                  {{ comment.created_at[:16] if comment.created_at is string else comment.created_at.strftime('%Y-%m-%d %H:%M') }}
                </span>
                <span class="separator text-xs text-gray-400">Â·</span>
                <span class="author-name font-medium text-gray-700">
                  {{ comment.users.display_name or comment.users.username }}
                </span>
                {% if comment.users and comment.users.is_admin %}
                <span class="admin-badge px-1.5 py-0.5 bg-red-100 text-red-600 text-xs rounded">ê´€ë¦¬ì</span>
                {% endif %}
                {% if comment.updated_at and comment.updated_at > comment.created_at %}
                <span class="updated-badge text-xs text-gray-400">(ìˆ˜ì •ë¨)</span>
                {% endif %}
              </div>

              <!-- Comment Actions -->
              <div class="comment-actions flex items-center space-x-2">
                {% if current_user and (board.slug not in ['notice', 'newsletter'] or current_user.is_admin) %}
                <button
                  onclick="toggleReplyForm({{ comment.id }})"
                  class="reply-btn text-blue-600 hover:text-blue-800 text-xs transition-colors"
                >
                  ë‹µê¸€
                </button>
                {% endif %}

                {% if current_user and (current_user.id == comment.user_id or current_user.is_admin) %}
                <button
                  onclick="editComment({{ comment.id }})"
                  class="edit-btn text-gray-600 hover:text-gray-800 text-xs transition-colors"
                >
                  ìˆ˜ì •
                </button>
                <button
                  onclick="deleteComment({{ comment.id }})"
                  class="delete-btn text-red-600 hover:text-red-800 text-xs transition-colors"
                >
                  ì‚­ì œ
                </button>
                {% endif %}
              </div>
            </div>

            <div class="comment-content text-gray-800" style="white-space: pre-line;">
              {{ comment.content|safe }}
            </div>
          </div>

          <!-- Reply Form (hidden by default) -->
          <div class="reply-form hidden mt-4 ml-6 p-4 bg-gray-50 rounded-md" id="reply-form-{{ comment.id }}">
            <form action="/posts/{{ post.id }}/comments" method="POST" class="space-y-3">
              <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
              <input type="hidden" name="parent_id" value="{{ comment.id }}"/>

              <textarea
                name="content"
                rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."
                required
                maxlength="1000"
              ></textarea>

              <div class="flex justify-end space-x-2">
                <button
                  type="button"
                  onclick="toggleReplyForm({{ comment.id }})"
                  class="px-3 py-1 text-gray-600 border border-gray-300 rounded text-sm hover:bg-gray-100 transition-colors"
                >
                  ì·¨ì†Œ
                </button>
                <button
                  type="submit"
                  class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 transition-colors"
                >
                  ë‹µê¸€ ë“±ë¡
                </button>
              </div>
            </form>
          </div>

          <!-- Replies -->
          {% if comment.replies %}
          <div class="replies ml-6 mt-4 space-y-4">
            {% for reply in comment.replies %}
            <div class="reply-item border-l-2 border-blue-200 pl-4">
              <div class="reply-header flex items-center justify-between mb-2">
                <div class="reply-author flex items-center space-x-2">
                  <span class="reply-date text-xs text-gray-500">
                    {{ reply.created_at[:16] if reply.created_at is string else reply.created_at.strftime('%Y-%m-%d %H:%M') }}
                  </span>
                  <span class="separator text-xs text-gray-400">Â·</span>
                  <span class="author-name font-medium text-gray-700 text-sm">
                    {{ reply.users.display_name or reply.users.username }}
                  </span>
                  {% if reply.users and reply.users.is_admin %}
                  <span class="admin-badge px-1.5 py-0.5 bg-red-100 text-red-600 text-xs rounded">ê´€ë¦¬ì</span>
                  {% endif %}
                </div>

                {% if current_user and (current_user.id == reply.user_id or current_user.is_admin) %}
                <div class="reply-actions flex items-center space-x-2">
                  <button
                    onclick="editComment({{ reply.id }})"
                    class="edit-btn text-gray-600 hover:text-gray-800 text-xs transition-colors"
                  >
                    ìˆ˜ì •
                  </button>
                  <button
                    onclick="deleteComment({{ reply.id }})"
                    class="delete-btn text-red-600 hover:text-red-800 text-xs transition-colors"
                  >
                    ì‚­ì œ
                  </button>
                </div>
                {% endif %}
              </div>

              <div class="reply-content text-gray-800 text-sm" style="white-space: pre-line;">
                {{ reply.content|safe }}
              </div>
            </div>
            {% endfor %}
          </div>
          {% endif %}
        </div>
        {% endfor %}
      {% else %}
      <!-- Empty Comments State -->
      <div class="empty-comments text-center py-12">
        <div class="text-gray-400 text-4xl mb-4">ğŸ’¬</div>
        <h4 class="text-lg font-medium text-gray-700 mb-2">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤</h4>
        <p class="text-gray-500">ì²« ë²ˆì§¸ ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
      </div>
      {% endif %}
    </div>
  </section>
</main>

<!-- Delete Confirmation Modal -->
<!-- ì¼ë°˜ ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
<div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-lg p-6 max-w-md w-full">
      <h3 class="text-lg font-medium text-gray-900 mb-4">ì‚­ì œ í™•ì¸</h3>
      <p class="text-gray-600 mb-6">ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
      <div class="flex justify-end space-x-3">
        <button
          onclick="closeDeleteModal()"
          class="px-4 py-2 text-gray-600 border border-gray-300 rounded hover:bg-gray-100 transition-colors"
        >
          ì·¨ì†Œ
        </button>
        <button
          id="confirm-delete-btn"
          class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors"
        >
          ì‚­ì œ
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ëŒ“ê¸€ í™•ì¸ ëª¨ë‹¬ -->
<div id="comment-check-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-lg p-6 max-w-lg w-full">
      <h3 class="text-lg font-medium text-gray-900 mb-4">âš ï¸ ê²Œì‹œê¸€ ì‚­ì œ ì•ˆë‚´</h3>
      <div id="comment-warning-content" class="text-gray-600 mb-6">
        <!-- ë™ì ìœ¼ë¡œ ë‚´ìš©ì´ ì„¤ì •ë©ë‹ˆë‹¤ -->
      </div>
      <div class="flex justify-end space-x-3">
        <button
          onclick="closeCommentCheckModal()"
          class="px-4 py-2 text-gray-600 border border-gray-300 rounded hover:bg-gray-100 transition-colors"
        >
          ì·¨ì†Œ
        </button>
        <button
          id="force-delete-btn"
          class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors hidden"
        >
          í™•ì¸
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Character counter for comment form
document.addEventListener('DOMContentLoaded', function() {
  const commentTextarea = document.getElementById('comment-content');
  const charCount = document.querySelector('.char-count');

  if (commentTextarea && charCount) {
    commentTextarea.addEventListener('input', function() {
      charCount.textContent = this.value.length;
    });
  }
});

// Reply form toggle
function toggleReplyForm(commentId) {
  const replyForm = document.getElementById(`reply-form-${commentId}`);
  if (replyForm) {
    replyForm.classList.toggle('hidden');
    if (!replyForm.classList.contains('hidden')) {
      const textarea = replyForm.querySelector('textarea');
      if (textarea) {
        textarea.focus();
      }
    }
  }
}

// Copy URL function
function copyUrl() {
  navigator.clipboard.writeText(window.location.href).then(function() {
    alert('ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
  });
}

// Delete confirmation
let deleteType = '';
let deleteId = 0;

async function confirmDelete(postId) {
  deleteType = 'post';
  deleteId = postId;

  try {
    // ê²Œì‹œê¸€ ì‚­ì œ ì „ ëŒ“ê¸€ ìƒíƒœ í™•ì¸
    const response = await fetch(`/posts/${postId}/check-comments`, {
      method: 'GET',
      credentials: 'same-origin'
    });

    if (response.ok) {
      const commentData = await response.json();

      if (commentData.has_others_comments) {
        // íƒ€ì¸ì˜ ëŒ“ê¸€ì´ ìˆëŠ” ê²½ìš°
        showCommentWarning(commentData);
      } else if (commentData.total_comments > 0) {
        // ì‘ì„±ìì˜ ëŒ“ê¸€ë§Œ ìˆëŠ” ê²½ìš°
        showOwnCommentsWarning(commentData);
      } else {
        // ëŒ“ê¸€ì´ ì—†ëŠ” ê²½ìš° ë°”ë¡œ ì‚­ì œ í™•ì¸
        document.getElementById('delete-modal').classList.remove('hidden');
      }
    } else {
      // API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ëª¨ë‹¬ í‘œì‹œ
      document.getElementById('delete-modal').classList.remove('hidden');
    }
  } catch (error) {
    console.error('ëŒ“ê¸€ í™•ì¸ ì‹¤íŒ¨:', error);
    // ì—ëŸ¬ ì‹œ ê¸°ë³¸ ëª¨ë‹¬ í‘œì‹œ
    document.getElementById('delete-modal').classList.remove('hidden');
  }
}

function showCommentWarning(commentData) {
  const warningContent = document.getElementById('comment-warning-content');
  warningContent.innerHTML = `
    <div class="space-y-3">
      <p class="text-red-600 font-medium">âŒ ê²Œì‹œê¸€ì„ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
      <p>ì´ ê²Œì‹œê¸€ì—ëŠ” <strong>${commentData.others_comments}ê°œì˜ íƒ€ì¸ì´ ì‘ì„±í•œ ëŒ“ê¸€/ë‹µê¸€</strong>ì´ ìˆìŠµë‹ˆë‹¤.</p>
      <p class="text-gray-700">ëŒ“ê¸€ì´ë‚˜ ë‹µê¸€ ì‘ì„±ìê°€ ë¨¼ì € ëŒ“ê¸€ì´ë‚˜ ë‹µê¸€ì„ ì‚­ì œí•œ í›„ ì‚­ì œí•´ì£¼ì„¸ìš”.</p>
      <div class="bg-gray-100 p-3 rounded-md text-sm">
        <p>â€¢ ì „ì²´ ëŒ“ê¸€/ë‹µê¸€: ${commentData.total_comments}ê°œ</p>
        <p>â€¢ íƒ€ì¸ì˜ ëŒ“ê¸€/ë‹µê¸€: ${commentData.others_comments}ê°œ</p>
        <p>â€¢ ë‚´ ëŒ“ê¸€/ë‹µê¸€: ${commentData.own_comments}ê°œ</p>
      </div>
    </div>
  `;

  // í™•ì¸ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
  document.getElementById('force-delete-btn').classList.add('hidden');
  document.getElementById('comment-check-modal').classList.remove('hidden');
}

function showOwnCommentsWarning(commentData) {
  const warningContent = document.getElementById('comment-warning-content');
  warningContent.innerHTML = `
    <div class="space-y-3">
      <p class="text-orange-600 font-medium">âš ï¸ ëŒ“ê¸€ê³¼ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.</p>
      <p>ì´ ê²Œì‹œê¸€ì—ëŠ” <strong>${commentData.own_comments}ê°œì˜ ë‚´ê°€ ì‘ì„±í•œ ëŒ“ê¸€/ë‹µê¸€</strong>ì´ ìˆìŠµë‹ˆë‹¤.</p>
      <p class="text-gray-700">ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ë©´ í•´ë‹¹ ê¸€ì— ë‹¬ë¦° <strong>ëª¨ë“  ëŒ“ê¸€ê³¼ ë‹µê¸€ì´ í•¨ê»˜ ì‚­ì œ</strong>ë©ë‹ˆë‹¤.</p>
      <div class="bg-yellow-50 border border-yellow-200 p-3 rounded-md text-sm">
        <p class="text-yellow-800">â€¢ ì „ì²´ ëŒ“ê¸€/ë‹µê¸€: ${commentData.total_comments}ê°œ (ëª¨ë‘ ì‚­ì œë¨)</p>
        <p class="text-yellow-800">â€¢ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
      <p class="text-red-600 font-medium">ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
    </div>
  `;

  // í™•ì¸ ë²„íŠ¼ í‘œì‹œ
  document.getElementById('force-delete-btn').classList.remove('hidden');
  document.getElementById('comment-check-modal').classList.remove('hidden');
}

function deleteComment(commentId) {
  deleteType = 'comment';
  deleteId = commentId;
  document.getElementById('delete-modal').classList.remove('hidden');
}

function closeDeleteModal() {
  document.getElementById('delete-modal').classList.add('hidden');
}

function closeCommentCheckModal() {
  document.getElementById('comment-check-modal').classList.add('hidden');
}

// Confirm delete button handler
document.getElementById('confirm-delete-btn').addEventListener('click', function() {
  console.log('ì‚­ì œ í™•ì¸ ë²„íŠ¼ í´ë¦­ë¨');
  console.log('deleteType:', deleteType);
  console.log('deleteId:', deleteId);
  
  if (deleteType === 'post') {
    console.log('ê²Œì‹œê¸€ ì‚­ì œ ì‹œì‘');
    
    // ê°„ë‹¨í•œ ë°©ë²•: window.locationì„ ì‚¬ìš©í•œ POST ëŒ€ì‹  ì§ì ‘ ì„œë²„ í˜¸ì¶œ
    try {
      console.log('fetchë¥¼ ì‚¬ìš©í•œ ì‚­ì œ ìš”ì²­');
      
      const formData = new FormData();
      formData.append('csrf_token', '{{ csrf_token }}');
      formData.append('force_delete', 'true');  // ê°•ì œ ì‚­ì œë¡œ ë³€ê²½
      
      fetch(`/posts/${deleteId}/delete`, {
        method: 'POST',
        body: formData,
        credentials: 'include',  // ì¿ í‚¤ í¬í•¨
        redirect: 'follow'
      })
      .then(response => {
        console.log('ì‚­ì œ ì‘ë‹µ:', response.status, response.statusText);
        console.log('ì‘ë‹µ í—¤ë”:', [...response.headers.entries()]);
        
        if (response.ok || response.status === 302) {
          console.log('ì‚­ì œ ì„±ê³µ, ë¦¬ë‹¤ì´ë ‰íŠ¸ ì²˜ë¦¬');
          // ìˆ˜ë™ìœ¼ë¡œ ê²Œì‹œíŒ ëª©ë¡ìœ¼ë¡œ ì´ë™
          window.location.href = '/boards/free';
        } else {
          console.error('ì‚­ì œ ì‹¤íŒ¨:', response.status, response.statusText);
          
          // ì‘ë‹µ ë³¸ë¬¸ë„ í™•ì¸
          response.text().then(text => {
            console.error('ì‘ë‹µ ë‚´ìš©:', text);
            alert(`ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (${response.status}: ${response.statusText})`);
          });
        }
      })
      .catch(error => {
        console.error('ì‚­ì œ ìš”ì²­ ì˜¤ë¥˜:', error);
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      });
      
    } catch (error) {
      console.error('ì‚­ì œ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
      alert('ì‚­ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  } else if (deleteType === 'comment') {
    // Create form to delete comment
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/comments/${deleteId}/delete`;
    form.innerHTML = `
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
    `;
    document.body.appendChild(form);
    form.submit();
  }
});

// Force delete button handler (for posts with own comments)
document.getElementById('force-delete-btn').addEventListener('click', function() {
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = `/posts/${deleteId}/delete`;
  form.innerHTML = `
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
    <input type="hidden" name="force_delete" value="true"/>
  `;
  document.body.appendChild(form);
  form.submit();
});

// Edit comment (placeholder)
function editComment(commentId) {
  // TODO: Implement inline comment editing
  alert('ëŒ“ê¸€ ìˆ˜ì • ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.');
}

// Close modal when clicking outside
document.getElementById('delete-modal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeDeleteModal();
  }
});

document.getElementById('comment-check-modal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeCommentCheckModal();
  }
});
</script>
{% endblock %}