{% extends "base.html" %}

{% block title %}ê²Œì‹œíŒ ê´€ë¦¬ - AIZEVA ê´€ë¦¬ì{% endblock %}

{% block content %}
<main class="container mx-auto px-4 py-8">
  <!-- Admin Header -->
  <div class="admin-header mb-8">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between">
      <div>
        <h1 class="text-3xl font-bold text-gray-800 mb-2">ê²Œì‹œíŒ ê´€ë¦¬</h1>
        <p class="text-gray-600">AIZEVA ê²Œì‹œíŒë“¤ì„ ê´€ë¦¬í•©ë‹ˆë‹¤</p>
      </div>

      <!-- Admin Navigation -->
      <div class="admin-nav mt-4 md:mt-0">
        <nav class="flex space-x-4">
          <a
            href="/admin/users/page"
            class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 text-sm transition-colors"
          >
            ì‚¬ìš©ì ê´€ë¦¬
          </a>
          <a
            href="/admin/boards/page"
            class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm transition-colors"
          >
            ê²Œì‹œíŒ ê´€ë¦¬
          </a>
        </nav>
      </div>
    </div>
  </div>

  <!-- Actions Bar -->
  <div id="stats-section" class="actions-bar bg-white p-6 rounded-lg shadow border mb-6">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <!-- Search -->
      <div class="search-box flex-1">
        <form method="GET" action="/admin/boards/page" class="flex">
          <input
            type="text"
            name="q"
            value="{{ request.query_params.get('q', '') }}"
            placeholder="ê²Œì‹œíŒ ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰..."
            class="flex-1 border border-gray-300 rounded-l-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
          <button
            type="submit"
            class="bg-blue-600 text-white px-4 py-2 rounded-r-md hover:bg-blue-700 text-sm transition-colors"
          >
            ê²€ìƒ‰
          </button>
        </form>
      </div>

      <!-- Create Board -->
      <div class="create-action">
        <button
          onclick="showCreateBoardModal()"
          class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm transition-colors"
        >
          ìƒˆ ê²Œì‹œíŒ ë§Œë“¤ê¸°
        </button>
      </div>
    </div>
  </div>

  <!-- Success/Error Messages -->
  {% if request.query_params.get('message') %}
  <div class="bg-green-50 border border-green-200 rounded-md p-4 mb-6">
    <div class="flex">
      <div class="flex-shrink-0">
        <svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
        </svg>
      </div>
      <div class="ml-3">
        <p class="text-sm font-medium text-green-800">
          {{ request.query_params.get('message') }}
        </p>
      </div>
      <div class="ml-auto pl-3">
        <div class="-mx-1.5 -my-1.5">
          <button type="button" onclick="this.parentElement.parentElement.parentElement.parentElement.style.display='none'" class="inline-flex rounded-md p-1.5 text-green-500 hover:bg-green-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-green-50 focus:ring-green-600">
            <span class="sr-only">Dismiss</span>
            <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  {% if request.query_params.get('error') %}
  <div class="bg-red-50 border border-red-200 rounded-md p-4 mb-6">
    <div class="flex">
      <div class="flex-shrink-0">
        <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
        </svg>
      </div>
      <div class="ml-3">
        <p class="text-sm font-medium text-red-800">
          {{ request.query_params.get('error') }}
        </p>
      </div>
      <div class="ml-auto pl-3">
        <div class="-mx-1.5 -my-1.5">
          <button type="button" onclick="this.parentElement.parentElement.parentElement.parentElement.style.display='none'" class="inline-flex rounded-md p-1.5 text-red-500 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-red-50 focus:ring-red-600">
            <span class="sr-only">Dismiss</span>
            <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Boards Grid -->
  <div class="boards-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for board in boards %}
    <div class="board-card bg-white p-6 rounded-lg shadow border hover:shadow-md transition-shadow">
      <!-- Board Header -->
      <div class="board-header mb-4">
        <div class="flex items-start justify-between mb-2">
          <h3 class="text-lg font-semibold text-gray-800">{{ board.name }}</h3>
          <div class="board-actions flex space-x-1">
            <button
              onclick="editBoard({{ board.id }})"
              class="p-1 text-gray-500 hover:text-blue-600 transition-colors"
              title="í¸ì§‘"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
              </svg>
            </button>
            <button
              onclick="confirmDeleteBoard({{ board.id }}, '{{ board.name }}')"
              class="p-1 text-gray-500 hover:text-red-600 transition-colors"
              title="ì‚­ì œ"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
            </button>
          </div>
        </div>
        <p class="text-gray-600 text-sm mb-3">{{ board.description }}</p>
        <div class="board-slug text-xs text-gray-500 font-mono bg-gray-100 px-2 py-1 rounded">
          /boards/{{ board.slug }}
        </div>
      </div>

      <!-- Board Stats -->
      <div class="board-stats mb-4">
        <div class="grid grid-cols-2 gap-4 text-center">
          <div class="stat">
            <div class="text-lg font-bold text-blue-600">{{ board.post_count or 0 }}</div>
            <div class="text-xs text-gray-600">ê²Œì‹œê¸€</div>
          </div>
          <div class="stat">
            <div class="text-lg font-bold text-green-600">{{ board.comment_count or 0 }}</div>
            <div class="text-xs text-gray-600">ëŒ“ê¸€</div>
          </div>
        </div>
      </div>

      <!-- Board Settings -->
      <div class="board-settings mb-4">
        <div class="setting-item flex justify-between items-center mb-2">
          <span class="text-sm text-gray-600">ì‘ì„± ê¶Œí•œ</span>
          <span class="inline-block px-2 py-1 text-xs rounded-full {% if board.write_permission == 'all' %}bg-green-100 text-green-600{% elif board.write_permission == 'member' %}bg-blue-100 text-blue-600{% else %}bg-gray-100 text-gray-600{% endif %}">
            {% if board.write_permission == 'all' %}
              ì „ì²´ ê³µê°œ
            {% elif board.write_permission == 'member' %}
              íšŒì›ë§Œ
            {% else %}
              ê´€ë¦¬ìë§Œ
            {% endif %}
          </span>
        </div>
        <div class="setting-item flex justify-between items-center">
          <span class="text-sm text-gray-600">ìƒì„±ì¼</span>
          <span class="text-sm text-gray-500">{{ board.created_at[:10] if board.created_at else '' }}</span>
        </div>
      </div>

      <!-- Latest Activity -->
      {% if board.latest_post %}
      <div class="latest-activity border-t pt-4">
        <div class="text-xs text-gray-500 mb-1">ìµœê·¼ ê²Œì‹œê¸€</div>
        <div class="latest-post">
          <a
            href="/posts/{{ board.latest_post.id }}"
            class="text-sm text-gray-700 hover:text-blue-600 line-clamp-1 transition-colors"
          >
            {{ board.latest_post.title }}
          </a>
          <div class="text-xs text-gray-500 mt-1">
            by {{ board.latest_post.author_name }} Â· {{ board.latest_post.created_at[:16] if board.latest_post.created_at else '' }}
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Quick Actions -->
      <div class="quick-actions mt-4 pt-4 border-t">
        <div class="flex space-x-2">
          <a
            href="/boards/{{ board.slug }}"
            class="flex-1 text-center px-3 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 transition-colors"
          >
            ê²Œì‹œíŒ ë³´ê¸°
          </a>
          <button
            onclick="editBoard({{ board.id }})"
            class="flex-1 text-center px-3 py-2 border border-gray-300 text-gray-700 rounded text-sm hover:bg-gray-50 transition-colors"
          >
            í¸ì§‘
          </button>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Empty State -->
  {% if not boards %}
  <div class="empty-state text-center py-12">
    {% if request.query_params.get('q') %}
    <div class="text-gray-400 text-6xl mb-4">ğŸ”</div>
    <h3 class="text-lg font-medium text-gray-700 mb-2">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
    <p class="text-gray-500 mb-4">ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¡œ ì‹œë„í•´ë³´ì„¸ìš”</p>
    <a
      href="/admin/boards/page"
      class="inline-block px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
    >
      ì „ì²´ ê²Œì‹œíŒ ë³´ê¸°
    </a>
    {% else %}
    <div class="text-gray-400 text-6xl mb-4">ğŸ“‹</div>
    <h3 class="text-lg font-medium text-gray-700 mb-2">ì•„ì§ ê²Œì‹œíŒì´ ì—†ìŠµë‹ˆë‹¤</h3>
    <p class="text-gray-500 mb-4">ì²« ë²ˆì§¸ ê²Œì‹œíŒì„ ë§Œë“¤ì–´ë³´ì„¸ìš”</p>
    <button
      onclick="showCreateBoardModal()"
      class="inline-block px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors"
    >
      ê²Œì‹œíŒ ë§Œë“¤ê¸°
    </button>
    {% endif %}
  </div>
  {% endif %}
</main>

<!-- Create/Edit Board Modal -->
<div id="board-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-lg p-6 max-w-md w-full">
      <h3 class="text-lg font-medium text-gray-900 mb-4" id="board-modal-title">ìƒˆ ê²Œì‹œíŒ ë§Œë“¤ê¸°</h3>

      <form id="board-form" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
        <input type="hidden" id="board-id" name="board_id" value=""/>

        <!-- Board Name -->
        <div class="form-group mb-4">
          <label for="board-name" class="block text-sm font-medium text-gray-700 mb-2">
            ê²Œì‹œíŒ ì´ë¦„ <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="board-name"
            name="name"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="ê²Œì‹œíŒ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
            required
            maxlength="100"
          />
        </div>

        <!-- Board Slug -->
        <div class="form-group mb-4">
          <label for="board-slug" class="block text-sm font-medium text-gray-700 mb-2">
            URL ìŠ¬ëŸ¬ê·¸ <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="board-slug"
            name="slug"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="ì˜ë¬¸ì, ìˆ«ì, í•˜ì´í”ˆë§Œ ì‚¬ìš©"
            required
            maxlength="50"
            pattern="^[a-z0-9-]+$"
          />
          <div class="text-xs text-gray-500 mt-1">URL: /boards/<span id="slug-preview"></span></div>
        </div>

        <!-- Board Description -->
        <div class="form-group mb-4">
          <label for="board-description" class="block text-sm font-medium text-gray-700 mb-2">
            ì„¤ëª…
          </label>
          <textarea
            id="board-description"
            name="description"
            rows="3"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="ê²Œì‹œíŒì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
            maxlength="500"
          ></textarea>
        </div>

        <!-- Write Permission -->
        <div class="form-group mb-6">
          <label for="write-permission" class="block text-sm font-medium text-gray-700 mb-2">
            ì‘ì„± ê¶Œí•œ <span class="text-red-500">*</span>
          </label>
          <select
            id="write-permission"
            name="write_permission"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          >
            <option value="all">ì „ì²´ ê³µê°œ (ë¹„íšŒì›ë„ ê°€ëŠ¥)</option>
            <option value="member" selected>íšŒì›ë§Œ ì‘ì„± ê°€ëŠ¥</option>
            <option value="admin">ê´€ë¦¬ìë§Œ ì‘ì„± ê°€ëŠ¥</option>
          </select>
        </div>

        <!-- Form Actions -->
        <div class="flex justify-end space-x-3">
          <button
            type="button"
            onclick="closeBoardModal()"
            class="px-4 py-2 text-gray-600 border border-gray-300 rounded hover:bg-gray-100 transition-colors"
          >
            ì·¨ì†Œ
          </button>
          <button
            type="submit"
            class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
          >
            ì €ì¥
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-lg p-6 max-w-md w-full">
      <h3 class="text-lg font-medium text-gray-900 mb-4">ê²Œì‹œíŒ ì‚­ì œ</h3>
      <p class="text-gray-600 mb-6" id="delete-message">
        ì •ë§ë¡œ ì´ ê²Œì‹œíŒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê²Œì‹œíŒ ë‚´ì˜ ëª¨ë“  ê²Œì‹œê¸€ê³¼ ëŒ“ê¸€ì´ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤. ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
      </p>
      <div class="flex justify-end space-x-3">
        <button
          onclick="closeDeleteModal()"
          class="px-4 py-2 text-gray-600 border border-gray-300 rounded hover:bg-gray-100 transition-colors"
        >
          ì·¨ì†Œ
        </button>
        <button
          id="confirm-delete-btn"
          class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors"
        >
          ì‚­ì œ
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Board creation/editing
function showCreateBoardModal() {
  document.getElementById('board-modal-title').textContent = 'ìƒˆ ê²Œì‹œíŒ ë§Œë“¤ê¸°';
  document.getElementById('board-form').action = '/admin/boards';
  document.getElementById('board-id').value = '';
  document.getElementById('board-name').value = '';
  document.getElementById('board-slug').value = '';
  document.getElementById('board-description').value = '';
  document.getElementById('write-permission').value = 'member';
  
  // ìŠ¬ëŸ¬ê·¸ ë¯¸ë¦¬ë³´ê¸°ë„ ì´ˆê¸°í™”
  const slugPreview = document.getElementById('slug-preview');
  if (slugPreview) {
    slugPreview.textContent = '';
  }
  
  document.getElementById('board-modal').classList.remove('hidden');
  document.getElementById('board-name').focus();
  
  console.log('Modal opened - fields reset');
}

async function editBoard(boardId) {
  try {
    // ê²Œì‹œíŒ ë°ì´í„° ì¡°íšŒ
    const response = await fetch(`/admin/boards/${boardId}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    });

    if (!response.ok) {
      throw new Error('ê²Œì‹œíŒ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }

    const data = await response.json();
    const board = data.board;

    // ëª¨ë‹¬ ì œëª© ë° í¼ ì„¤ì •
    document.getElementById('board-modal-title').textContent = 'ê²Œì‹œíŒ í¸ì§‘';
    document.getElementById('board-form').action = `/admin/boards/${boardId}`;
    document.getElementById('board-form').method = 'POST';
    document.getElementById('board-id').value = boardId;
    
    // ìƒˆë¡œìš´ CSRF í† í°ìœ¼ë¡œ ì—…ë°ì´íŠ¸
    if (data.csrf_token) {
      const csrfInput = document.querySelector('input[name="csrf_token"]');
      if (csrfInput) {
        csrfInput.value = data.csrf_token;
        console.log('Updated CSRF Token in edit mode:', data.csrf_token);
      }
    }

    // ê¸°ì¡´ ë°ì´í„°ë¡œ í¼ ì±„ìš°ê¸°
    document.getElementById('board-name').value = board.name || '';
    document.getElementById('board-slug').value = board.slug || '';
    document.getElementById('board-slug').readOnly = true; // ìŠ¬ëŸ¬ê·¸ëŠ” í¸ì§‘ ì‹œ ë³€ê²½ ë¶ˆê°€
    document.getElementById('board-description').value = board.description || '';
    document.getElementById('write-permission').value = board.write_permission || 'member';

    // ìŠ¬ëŸ¬ê·¸ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
    const slugPreview = document.getElementById('slug-preview');
    if (slugPreview) {
      slugPreview.textContent = board.slug || '';
    }

    // Hidden input for HTTP method override (PUT)
    let methodInput = document.getElementById('method-override');
    if (!methodInput) {
      methodInput = document.createElement('input');
      methodInput.type = 'hidden';
      methodInput.name = '_method';
      methodInput.id = 'method-override';
      document.getElementById('board-form').appendChild(methodInput);
    }
    methodInput.value = 'PUT';

    // ëª¨ë‹¬ í‘œì‹œ
    document.getElementById('board-modal').classList.remove('hidden');
    document.getElementById('board-name').focus();

  } catch (error) {
    console.error('ê²Œì‹œíŒ í¸ì§‘ ì˜¤ë¥˜:', error);
    alert('ê²Œì‹œíŒ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
  }
}

function closeBoardModal() {
  document.getElementById('board-modal').classList.add('hidden');
  
  // í¼ ë¦¬ì…‹ (í¸ì§‘ ëª¨ë“œì—ì„œ ë‚˜ì˜¬ ë•Œ)
  document.getElementById('board-form').reset();
  document.getElementById('board-slug').readOnly = false; // ìŠ¬ëŸ¬ê·¸ í¸ì§‘ ê°€ëŠ¥í•˜ê²Œ ë³µì›
  
  // Method override ì œê±°
  const methodInput = document.getElementById('method-override');
  if (methodInput) {
    methodInput.remove();
  }
  
  // ìŠ¬ëŸ¬ê·¸ ë¯¸ë¦¬ë³´ê¸° ì´ˆê¸°í™”
  const slugPreview = document.getElementById('slug-preview');
  if (slugPreview) {
    slugPreview.textContent = '';
  }
}

// Korean to English slug conversion - Updated 2025-09-29
function koreanToSlug(text) {
  console.log('=== SLUG DEBUG START ===');
  console.log('Input:', text, 'Type:', typeof text, 'Length:', text.length);
  
  // íŠ¹ìˆ˜ ì¼€ì´ìŠ¤ ì§ì ‘ ì²˜ë¦¬ (ê°€ì¥ ìš°ì„ )
  const directMappings = {
    'ì§ˆë¬¸': 'question',
    'ê³µì§€ì‚¬í•­': 'notice',
    'ê³µì§€': 'notice',
    'ììœ ê²Œì‹œíŒ': 'free', 
    'ììœ ': 'free',
    'ë‹µë³€': 'answer',
    'ë‰´ìŠ¤': 'news',
    'ì´ë²¤íŠ¸': 'event',
    'ê°¤ëŸ¬ë¦¬': 'gallery',
    'í† ë¡ ': 'discussion',
    'ê±´ì˜': 'suggestion'
  };

  const trimmedText = text.trim();
  console.log('Trimmed:', trimmedText);
  
  // ì§ì ‘ ë§¤í•‘ í™•ì¸
  if (directMappings.hasOwnProperty(trimmedText)) {
    console.log('Direct mapping found:', trimmedText, '->', directMappings[trimmedText]);
    console.log('=== SLUG DEBUG END ===');
    return directMappings[trimmedText];
  }
  
  // ì¶”ê°€ ë‹¨ì–´ë“¤
  const additionalWords = {
    'Q&A': 'qna',
    'ì§ˆë¬¸ê²Œì‹œíŒ': 'question',
    'í™ë³´': 'promotion',
    'ë¦¬ë·°': 'review',
    'ì‹ ê³ ': 'report',
    'ì‚¬ì§„': 'photo',
    'ë™ì˜ìƒ': 'video',
    'ìŒì•…': 'music',
    'ê²Œì„': 'game',
    'ìŠ¤í¬ì¸ ': 'sports',
    'ì •ì¹˜': 'politics',
    'ê²½ì œ': 'economy',
    'ì‚¬íšŒ': 'society',
    'ë¬¸í™”': 'culture',
    'ê¸°ìˆ ': 'tech',
    'ê³¼í•™': 'science',
    'êµìœ¡': 'education',
    'ì·¨ì—…': 'job',
    'ì—¬í–‰': 'travel',
    'ìš”ë¦¬': 'cooking',
    'ê±´ê°•': 'health',
    'ì—°ì• ': 'love',
    'ê²°í˜¼': 'marriage',
    'ìœ¡ì•„': 'parenting'
  };

  let result = trimmedText;
  console.log('Processing additional words...');
  
  // ì¶”ê°€ ë‹¨ì–´ ë§¤ì¹­
  const allWords = {...directMappings, ...additionalWords};
  const sortedWords = Object.entries(allWords).sort((a, b) => b[0].length - a[0].length);
  
  for (const [korean, english] of sortedWords) {
    if (result.includes(korean)) {
      console.log('Found partial match:', korean, '->', english);
      result = result.replace(new RegExp(korean, 'g'), english);
    }
  }
  
  console.log('After word replacement:', result);
  
  // ë‚¨ì€ í•œê¸€ê³¼ íŠ¹ìˆ˜ë¬¸ì ì²˜ë¦¬
  result = result
    .toLowerCase()
    .replace(/[ê°€-í£]/g, '')          // í•œê¸€ ì œê±°
    .replace(/[^a-z0-9\s-]/g, '-')   // íŠ¹ìˆ˜ë¬¸ì â†’ í•˜ì´í”ˆ
    .replace(/\s+/g, '-')            // ê³µë°± â†’ í•˜ì´í”ˆ
    .replace(/-+/g, '-')             // ì—°ì† í•˜ì´í”ˆ ì •ë¦¬
    .replace(/^-|-$/g, '');          // ì•ë’¤ í•˜ì´í”ˆ ì œê±°
  
  console.log('After cleanup:', result);
  
  // ë¹ˆ ë¬¸ìì—´ ì²˜ë¦¬
  if (!result || result === '') {
    result = 'board-' + Date.now().toString().slice(-6);
    console.log('Empty result, using fallback:', result);
  }
  
  console.log('Final result:', result);
  console.log('=== SLUG DEBUG END ===');
  return result;
}

// Slug generation
document.addEventListener('DOMContentLoaded', function() {
  const nameInput = document.getElementById('board-name');
  const slugInput = document.getElementById('board-slug');
  const slugPreview = document.getElementById('slug-preview');

  nameInput.addEventListener('input', function() {
    // í•­ìƒ ìŠ¬ëŸ¬ê·¸ë¥¼ ì—…ë°ì´íŠ¸ (ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ ìˆ˜ì •í•˜ì§€ ì•Šì€ ê²½ìš°)
    // ë˜ëŠ” ìŠ¬ëŸ¬ê·¸ê°€ ë¹„ì–´ìˆê±°ë‚˜ ì´ì „ì— ìë™ìƒì„±ëœ ê²½ìš°
    const currentSlug = slugInput.value;
    const isAutoGenerated = !currentSlug || currentSlug.startsWith('board-') || 
                           ['question', 'notice', 'free', 'answer', 'discussion'].includes(currentSlug);
    
    if (!currentSlug || isAutoGenerated || currentSlug === '') {
      console.log('Updating slug for input:', this.value);
      const slug = koreanToSlug(this.value);
      slugInput.value = slug;
      slugPreview.textContent = slug;
    }
  });

  slugInput.addEventListener('input', function() {
    slugPreview.textContent = this.value;
  });

  // Form submission
  document.getElementById('board-form').addEventListener('submit', function(e) {
    const slug = slugInput.value;
    if (!/^[a-z0-9-]+$/.test(slug)) {
      e.preventDefault();
      alert('ìŠ¬ëŸ¬ê·¸ëŠ” ì˜ë¬¸ ì†Œë¬¸ì, ìˆ«ì, í•˜ì´í”ˆë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
      return;
    }
  });
});

// Board deletion
let deleteTargetId = 0;

function confirmDeleteBoard(boardId, boardName) {
  deleteTargetId = boardId;
  document.getElementById('delete-message').innerHTML =
    `ì •ë§ë¡œ "<strong>${boardName}</strong>" ê²Œì‹œíŒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê²Œì‹œíŒ ë‚´ì˜ ëª¨ë“  ê²Œì‹œê¸€ê³¼ ëŒ“ê¸€ì´ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤. ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
  document.getElementById('delete-modal').classList.remove('hidden');
}

function closeDeleteModal() {
  document.getElementById('delete-modal').classList.add('hidden');
  deleteTargetId = 0;
}

document.getElementById('confirm-delete-btn').addEventListener('click', function() {
  if (deleteTargetId) {
    // í˜„ì¬ í˜ì´ì§€ì—ì„œ CSRF í† í° ê°€ì ¸ì˜¤ê¸°
    const csrfToken = document.querySelector('input[name="csrf_token"]')?.value || 
                      document.querySelector('meta[name="csrf-token"]')?.content ||
                      '{{ csrf_token }}';
    
    if (!csrfToken) {
      alert('CSRF í† í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê³  ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.');
      return;
    }
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/admin/boards/${deleteTargetId}/delete`;
    form.innerHTML = `
      <input type="hidden" name="csrf_token" value="${csrfToken}"/>
    `;
    document.body.appendChild(form);
    form.submit();
  }
});

// Close modals when clicking outside
document.getElementById('board-modal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeBoardModal();
  }
});

document.getElementById('delete-modal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeDeleteModal();
  }
});

// Form submission debugging
document.getElementById('board-form').addEventListener('submit', function(e) {
  console.log('=== BOARD FORM SUBMIT DEBUG ===');
  const formData = new FormData(this);
  for (let [key, value] of formData.entries()) {
    console.log(`${key}: ${value}`);
  }
  console.log('Form action:', this.action);
  console.log('Form method:', this.method);
  console.log('=== END DEBUG ===');
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
  // Escape to close modals
  if (e.key === 'Escape') {
    closeBoardModal();
    closeDeleteModal();
  }

  // Ctrl+N for new board
  if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
    e.preventDefault();
    showCreateBoardModal();
  }
});
</script>
{% endblock %}