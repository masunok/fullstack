{% extends "base.html" %}

{% block title %}
{% if mode == 'edit' %}글 수정{% else %}글 쓰기{% endif %} - {{ board.name }} - AIZEVA
{% endblock %}

{% block head %}
<!-- Quill.js Rich Text Editor -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
{% endblock %}

{% block content %}
<main class="container mx-auto px-4 py-8">
  <!-- Breadcrumb -->
  <nav class="breadcrumb mb-6">
    <div class="text-sm text-gray-500">
      <a href="/" class="hover:text-blue-600 transition-colors">홈</a>
      <span class="mx-2">></span>
      <a href="/boards" class="hover:text-blue-600 transition-colors">게시판</a>
      <span class="mx-2">></span>
      <a href="/boards/{{ board.slug }}" class="hover:text-blue-600 transition-colors">{{ board.name }}</a>
      <span class="mx-2">></span>
      <span class="text-gray-800">{% if mode == 'edit' %}글 수정{% else %}글 쓰기{% endif %}</span>
    </div>
  </nav>

  <!-- Page Header -->
  <div class="page-header mb-8">
    <h1 class="text-2xl md:text-3xl font-bold text-gray-800">
      {% if mode == 'edit' %}글 수정{% else %}글 쓰기{% endif %}
    </h1>
    <p class="text-gray-600 mt-2">{{ board.name }} 게시판</p>
    {% if board.write_permission != 'all' %}
    <div class="mt-2">
      <span class="inline-block px-2 py-1 text-xs rounded-full {% if board.write_permission == 'member' %}bg-blue-100 text-blue-600{% else %}bg-gray-100 text-gray-600{% endif %}">
        {% if board.write_permission == 'member' %}
          회원만 작성 가능
        {% else %}
          관리자만 작성 가능
        {% endif %}
      </span>
    </div>
    {% endif %}
  </div>

  <!-- Flash Messages (FastAPI compatible) -->
  {% if messages %}
    {% for message in messages %}
      <div class="mb-4 p-3 rounded-md {% if message.category == 'error' %}bg-red-50 border border-red-200 text-red-700{% else %}bg-green-50 border border-green-200 text-green-700{% endif %}">
        {{ message.content }}
      </div>
    {% endfor %}
  {% endif %}

  <!-- Post Form -->
  <div class="post-form-container bg-white rounded-lg shadow border">
    <form
      action="{% if mode == 'edit' %}/posts/{{ post.id }}/html{% else %}/boards/{{ board.slug }}/posts/html{% endif %}"
      method="POST"
      class="post-form p-6"
      id="post-form"
    >
      <!-- CSRF Token -->
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>

      <!-- Title -->
      <div class="form-group mb-6">
        <label for="title" class="block text-sm font-medium text-gray-700 mb-2">
          제목 <span class="text-red-500">*</span>
        </label>
        <input
          type="text"
          id="title"
          name="title"
          value="{{ post.title if mode == 'edit' else '' }}"
          class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
          placeholder="제목을 입력하세요"
          required
          maxlength="200"
        />
        <div class="flex justify-between text-xs text-gray-500 mt-1">
          <span>최대 200자</span>
          <span class="title-count">0/200</span>
        </div>
        {% if errors and errors.title %}
          <div class="error-message text-red-500 text-xs mt-1">{{ errors.title }}</div>
        {% endif %}
      </div>

      <!-- Content -->
      <div class="form-group mb-6">
        <label for="content" class="block text-sm font-medium text-gray-700 mb-2">
          내용 <span class="text-red-500">*</span>
        </label>

        <!-- Quill Editor Container -->
        <div class="editor-container">
          <div id="editor" class="bg-white" style="min-height: 300px;"></div>
          <textarea
            name="content"
            id="content"
            class="hidden"
            required
          >{{ post.content if mode == 'edit' else '' }}</textarea>
        </div>

        <div class="editor-info text-xs text-gray-500 mt-2">
          <div class="flex justify-between">
            <span>
              · 이미지는 Base64 형식으로 업로드됩니다 (1MB 제한)
              <br>
              · 기본적인 텍스트 서식을 지원합니다
            </span>
            <span class="content-count">0자</span>
          </div>
        </div>
        {% if errors and errors.content %}
          <div class="error-message text-red-500 text-xs mt-1">{{ errors.content }}</div>
        {% endif %}
      </div>


      <!-- Form Actions -->
      <div class="form-actions flex flex-col md:flex-row md:items-center md:justify-between pt-6 border-t">
        <div class="form-info mb-4 md:mb-0">
          <div class="text-sm text-gray-600">
            {% if mode == 'edit' %}
            <span>마지막 수정: {{ post.updated_at[:16] if post.updated_at else post.created_at[:16] }}</span>
            {% else %}
            <span>작성자: {{ current_user.display_name or current_user.username }}</span>
            {% endif %}
          </div>
        </div>

        <div class="form-buttons flex space-x-3">
          <a
            href="/boards/{{ board.slug }}"
            class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 text-sm transition-colors"
          >
            취소
          </a>
          <button
            type="submit"
            id="submit-btn"
            class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {% if mode == 'edit' %}수정하기{% else %}글 등록{% endif %}
          </button>
        </div>
      </div>

      <!-- General Error Message -->
      {% if errors and errors.general %}
        <div class="error-message text-red-500 text-sm text-center mt-4">{{ errors.general }}</div>
      {% endif %}
    </form>
  </div>
</main>

<script>
// Initialize Quill editor
let quill;

document.addEventListener('DOMContentLoaded', function() {
  // Initialize Quill
  quill = new Quill('#editor', {
    theme: 'snow',
    modules: {
      toolbar: [
        [{ 'header': [1, 2, 3, false] }],
        ['bold', 'italic', 'underline', 'strike'],
        [{ 'color': [] }, { 'background': [] }],
        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
        [{ 'align': [] }],
        ['blockquote', 'code-block'],
        ['link', 'image'],
        ['clean']
      ]
    },
    placeholder: '내용을 입력하세요...'
  });

  // Set initial content if editing
  const initialContent = document.getElementById('content').value;
  if (initialContent) {
    quill.root.innerHTML = initialContent;
  }

  // Update hidden textarea when content changes
  quill.on('text-change', function() {
    const content = quill.root.innerHTML;
    document.getElementById('content').value = content;
    updateContentCount();
  });

  // Title character counter
  const titleInput = document.getElementById('title');
  const titleCount = document.querySelector('.title-count');

  titleInput.addEventListener('input', function() {
    titleCount.textContent = `${this.value.length}/200`;
  });

  // Initial count
  titleCount.textContent = `${titleInput.value.length}/200`;

  // Form submission
  document.getElementById('post-form').addEventListener('submit', function(e) {
    const content = quill.root.innerHTML.trim();
    if (content === '<p><br></p>' || content === '') {
      e.preventDefault();
      alert('내용을 입력해주세요.');
      return;
    }

    // Update hidden field
    document.getElementById('content').value = content;

    // Disable submit button
    const submitBtn = document.getElementById('submit-btn');
    submitBtn.disabled = true;
    submitBtn.textContent = '처리 중...';
  });



  // Image upload handling
  quill.getModule('toolbar').addHandler('image', function() {
    const input = document.createElement('input');
    input.setAttribute('type', 'file');
    input.setAttribute('accept', 'image/*');
    input.click();

    input.onchange = function() {
      const file = input.files[0];
      if (file) {
        if (file.size > 1024 * 1024) { // 1MB limit
          alert('이미지 크기는 1MB 이하로 제한됩니다.');
          return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          const range = quill.getSelection();
          quill.insertEmbed(range.index, 'image', e.target.result);
        };
        reader.readAsDataURL(file);
      }
    };
  });
});

function updateContentCount() {
  const content = quill.getText().trim();
  document.querySelector('.content-count').textContent = `${content.length}자`;
}



// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
  // Ctrl+Enter for submit
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
    e.preventDefault();
    document.getElementById('post-form').submit();
  }
});
</script>
{% endblock %}