{% extends "base.html" %}

{% block title %}{{ board.name }} - AIZEVA{% endblock %}

{% block content %}
<main class="container mx-auto px-4 py-8">
  <!-- Breadcrumb -->
  <nav class="breadcrumb mb-6">
    <div class="text-sm text-gray-500">
      <a href="/" class="hover:text-blue-600 transition-colors">홈</a>
      <span class="mx-2">></span>
      <a href="/boards" class="hover:text-blue-600 transition-colors">게시판</a>
      <span class="mx-2">></span>
      <span class="text-gray-800">{{ board.name }}</span>
    </div>
  </nav>

  <!-- Board Header -->
  <div class="board-header mb-8">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between">
      <div class="board-info mb-4 md:mb-0">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">{{ board.name }}</h1>
        <p class="text-gray-600">{{ board.description }}</p>
        <div class="board-meta mt-2 text-sm text-gray-500">
          <span>게시글 {{ pagination.total_count }}개</span>
          <span class="mx-2">·</span>
          <span>페이지 {{ pagination.page }}/{{ pagination.total_pages }}</span>
          <span class="mx-2">·</span>
          <span class="inline-block px-2 py-1 text-xs rounded-full {% if board.write_permission == 'all' %}bg-green-100 text-green-600{% elif board.write_permission == 'member' %}bg-blue-100 text-blue-600{% else %}bg-gray-100 text-gray-600{% endif %}">
            {% if board.write_permission == 'all' %}
              전체 공개
            {% elif board.write_permission == 'member' %}
              회원만 작성
            {% else %}
              관리자만 작성
            {% endif %}
          </span>
        </div>
      </div>

      <!-- Actions -->
      <div class="board-actions">
        <div class="flex flex-col md:flex-row gap-2">
          <!-- Search -->
          <div class="search-box">
            <form method="GET" action="/boards/{{ board.slug }}" class="flex">
              <input
                type="text"
                name="q"
                value="{{ search }}"
                placeholder="게시글 검색..."
                class="px-3 py-2 border border-gray-300 rounded-l-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
              <button
                type="submit"
                class="px-3 py-2 bg-gray-600 text-white rounded-r-md text-sm hover:bg-gray-700 transition-colors"
              >
                검색
              </button>
            </form>
          </div>

          <!-- Write Post Button (if allowed) -->
          {% set can_write = (board.write_permission == 'all') or (board.write_permission == 'member' and current_user) or (current_user and current_user.is_admin) %}
          {% if can_write %}
          <a
            href="/boards/{{ board.slug }}/write"
            class="write-btn px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm transition-colors whitespace-nowrap"
          >
            글쓰기
          </a>
          {% elif not current_user %}
          <a
            href="/auth/login"
            class="write-btn px-4 py-2 border border-blue-600 text-blue-600 rounded-md hover:bg-blue-50 text-sm transition-colors whitespace-nowrap"
          >
            로그인
          </a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Search Results Info -->
  {% if search %}
  <div class="search-info mb-4 p-3 bg-blue-50 border border-blue-200 rounded-md">
    <span class="text-blue-700 text-sm">
      '<strong>{{ search }}</strong>' 검색 결과: {{ pagination.total_count }}개
    </span>
    <a href="/boards/{{ board.slug }}" class="ml-2 text-blue-600 hover:text-blue-800 text-sm">전체 보기</a>
  </div>
  {% endif %}

  <!-- Posts List -->
  <div class="posts-list bg-white rounded-lg shadow border">
    <!-- List Header (Desktop) -->
    <div class="list-header hidden md:flex bg-gray-50 border-b p-4 text-sm font-medium text-gray-700">
      <div class="flex-1">제목</div>
      <div class="w-24 text-center">작성자</div>
      <div class="w-20 text-center">조회</div>
      <div class="w-24 text-center">작성일</div>
    </div>

    <!-- Post Items -->
    <div class="post-items">
      {% for post in posts %}
      <!-- Post Item -->
      <div class="post-item border-b last:border-b-0 p-4 hover:bg-gray-50 transition-colors">
        <!-- Desktop Layout -->
        <div class="hidden md:flex items-center">
          <div class="post-title flex-1">
            <a
              href="/posts/{{ post.id }}"
              class="text-gray-800 hover:text-blue-600 font-medium transition-colors"
            >
              {{ post.title }}
            </a>
            {% if post.comment_count > 0 %}
            <span class="comment-count text-blue-600 ml-2 text-sm">[{{ post.comment_count }}]</span>
            {% endif %}
            {# TODO: NEW badge feature - temporarily disabled #}
          </div>
          <div class="post-author w-24 text-center text-sm text-gray-600">{{ post.users.display_name or post.users.username }}</div>
          <div class="post-views w-20 text-center text-sm text-gray-500">{{ post.view_count or 0 }}</div>
          <div class="post-date w-24 text-center text-sm text-gray-500">{{ post.created_at[:16] if post.created_at is string else post.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
        </div>

        <!-- Mobile Layout -->
        <div class="md:hidden">
          <div class="post-title mb-2">
            <a
              href="/posts/{{ post.id }}"
              class="text-gray-800 hover:text-blue-600 font-medium transition-colors"
            >
              {{ post.title }}
            </a>
            {% if post.comment_count > 0 %}
            <span class="comment-count text-blue-600 ml-2 text-sm">[{{ post.comment_count }}]</span>
            {% endif %}
            {# TODO: NEW badge feature - temporarily disabled #}
          </div>
          <div class="post-meta text-xs text-gray-500">
            <span>{{ post.users.display_name or post.users.username }}</span>
            <span class="mx-2">·</span>
            <span>{{ post.created_at[:16] if post.created_at is string else post.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
            <span class="mx-2">·</span>
            <span>조회 {{ post.view_count or 0 }}</span>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Empty State -->
    {% if not posts %}
    <div class="empty-state text-center py-12">
      {% if search %}
      <div class="text-gray-400 text-6xl mb-4">🔍</div>
      <h3 class="text-lg font-medium text-gray-700 mb-2">검색 결과가 없습니다</h3>
      <p class="text-gray-500 mb-4">다른 검색어로 시도해보세요</p>
      <a
        href="/boards/{{ board.slug }}"
        class="inline-block px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm transition-colors"
      >
        전체 게시글 보기
      </a>
      {% else %}
      <div class="text-gray-400 text-6xl mb-4">📄</div>
      <h3 class="text-lg font-medium text-gray-700 mb-2">아직 게시글이 없습니다</h3>
      <p class="text-gray-500 mb-4">첫 번째 게시글을 작성해보세요</p>
      {% if can_write %}
      <a
        href="/boards/{{ board.slug }}/write"
        class="inline-block px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm transition-colors"
      >
        글쓰기
      </a>
      {% elif not current_user %}
      <a
        href="/auth/login"
        class="inline-block px-4 py-2 border border-blue-600 text-blue-600 rounded-md hover:bg-blue-50 text-sm transition-colors"
      >
        로그인
      </a>
      {% endif %}
      {% endif %}
    </div>
    {% endif %}
  </div>

  <!-- Pagination -->
  {% if pagination and pagination.total_pages > 1 %}
  <div class="pagination mt-8">
    <div class="flex justify-center">
      <nav class="pagination-nav flex items-center space-x-2">
        <!-- First Page -->
        {% if pagination.page > 1 %}
        <a
          href="/boards/{{ board.slug }}?page=1{% if search %}&search={{ search }}{% endif %}"
          class="px-3 py-2 text-sm text-gray-600 hover:text-blue-600 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
        >
          처음
        </a>
        {% endif %}

        <!-- Previous -->
        {% if pagination.page > 1 %}
        <a
          href="/boards/{{ board.slug }}?page={{ pagination.page - 1 }}{% if search %}&search={{ search }}{% endif %}"
          class="px-3 py-2 text-sm text-gray-600 hover:text-blue-600 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
        >
          이전
        </a>
        {% endif %}

        <!-- Page Numbers -->
        {% set start_page = [1, pagination.page - 2]|max %}
        {% set end_page = [pagination.total_pages, pagination.page + 2]|min %}
        {% for page_num in range(start_page, end_page + 1) %}
          {% if page_num != pagination.page %}
          <a
            href="/boards/{{ board.slug }}?page={{ page_num }}{% if search %}&search={{ search }}{% endif %}"
            class="px-3 py-2 text-sm text-gray-600 hover:text-blue-600 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
          >
            {{ page_num }}
          </a>
          {% else %}
          <span class="px-3 py-2 text-sm text-white bg-blue-600 border border-blue-600 rounded-md">
            {{ page_num }}
          </span>
          {% endif %}
        {% endfor %}

        <!-- Next -->
        {% if pagination.page < pagination.total_pages %}
        <a
          href="/boards/{{ board.slug }}?page={{ pagination.page + 1 }}{% if search %}&search={{ search }}{% endif %}"
          class="px-3 py-2 text-sm text-gray-600 hover:text-blue-600 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
        >
          다음
        </a>
        {% endif %}

        <!-- Last Page -->
        {% if pagination.page < pagination.total_pages %}
        <a
          href="/boards/{{ board.slug }}?page={{ pagination.total_pages }}{% if search %}&search={{ search }}{% endif %}"
          class="px-3 py-2 text-sm text-gray-600 hover:text-blue-600 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
        >
          끝
        </a>
        {% endif %}
      </nav>
    </div>
  </div>
  {% endif %}
</main>

<script>
// Enhanced interactions
document.addEventListener('DOMContentLoaded', function() {
  // Search form enhancements
  const searchInput = document.querySelector('input[name="q"]');
  if (searchInput) {
    searchInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        this.closest('form').submit();
      }
    });
  }

  // Post item hover effects
  const postItems = document.querySelectorAll('.post-item');
  postItems.forEach(item => {
    item.addEventListener('click', function(e) {
      // Only trigger if clicking on the item itself, not on links
      if (e.target === this || e.target.classList.contains('post-title')) {
        const link = this.querySelector('a[href^="/posts/"]');
        if (link) {
          window.location.href = link.href;
        }
      }
    });
  });
});
</script>
{% endblock %}